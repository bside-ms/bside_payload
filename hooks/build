#!/bin/bash

if [ $SOURCE_BRANCH = "main" ]
then
  PAYLOAD_PUBLIC_CMS_URL=$PAYLOAD_PUBLIC_CMS_URL_PROD
  PAYLOAD_PUBLIC_SITE_URL=$PAYLOAD_PUBLIC_SITE_URL_PROD
else
  PAYLOAD_PUBLIC_CMS_URL=$PAYLOAD_PUBLIC_CMS_URL_DEV
  PAYLOAD_PUBLIC_SITE_URL=$PAYLOAD_PUBLIC_SITE_URL_DEV
fi

docker build \
  -t $IMAGE_NAME \
  --build-arg PAYLOAD_PUBLIC_CMS_URL=$PAYLOAD_PUBLIC_CMS_URL \
  --build-arg PAYLOAD_PUBLIC_SITE_URL=$PAYLOAD_PUBLIC_SITE_URL  \
  --build-arg PAYLOAD_PUBLIC_OAUTH_SERVER=$PAYLOAD_PUBLIC_OAUTH_SERVER  \
  --build-arg CLIENT_ID=$CLIENT_ID  \
  --build-arg CLIENT_SECRET=$CLIENT_SECRET  \
  .

docker tag $IMAGE_NAME $DOCKER_REPO:$SOURCE_COMMIT
docker push $DOCKER_REPO:$SOURCE_COMMIT
